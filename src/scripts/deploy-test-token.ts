// Deploy a simple ERC20 test token to Sepolia
import { ethers } from 'ethers';
import * as fs from 'fs';
import * as path from 'path';

// Simple ERC20 contract (OpenZeppelin-style)
const ERC20_ABI = [
    'constructor(string name, string symbol, uint256 initialSupply)',
    'function name() view returns (string)',
    'function symbol() view returns (string)',
    'function decimals() view returns (uint8)',
    'function totalSupply() view returns (uint256)',
    'function balanceOf(address) view returns (uint256)',
    'function transfer(address to, uint256 amount) returns (bool)',
    'function approve(address spender, uint256 amount) returns (bool)',
    'function allowance(address owner, address spender) view returns (uint256)',
    'function transferFrom(address from, address to, uint256 amount) returns (bool)',
];

// Minimal ERC20 bytecode (we'll use a pre-deployed contract factory or deploy inline)
// For simplicity, we'll deploy using a simple contract
const ERC20_BYTECODE = '0x60806040523480156200001157600080fd5b506040516200124638038062001246833981810160405281019062000037919062000314565b82600390816200004891906200060a565b5081600490816200005a91906200060a565b508060058190555080600080620000766200010060201b60201c565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505050506200072c565b600033905090565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6200011182620000c6565b810181811067ffffffffffffffff82111715620001335762000132620000d7565b5b80604052505050565b60006200014862000108565b905062000156828262000106565b919050565b600067ffffffffffffffff821115620001795762000178620000d7565b5b6200018482620000c6565b9050602081019050919050565b60005b83811015620001b157808201518184015260208101905062000194565b60008484015250505050565b6000620001d4620001ce846200015b565b6200013c565b905082815260208101848484011115620001f357620001f2620000c1565b5b6200020084828562000191565b509392505050565b600082601f830112620002205762000021f620000bc565b5b815162000232848260208601620001bd565b91505092915050565b6000819050919050565b62000250816200023b565b81146200025c57600080fd5b50565b600081519050620002708162000245565b92915050565b600080600060608486031215620002925762000291620000b2565b5b600084015167ffffffffffffffff811115620002b357620002b2620000b7565b5b620002c18682870162000208565b935050602084015167ffffffffffffffff811115620002e557620002e4620000b7565b5b620002f38682870162000208565b9250506040620003068682870162000025f565b9150509250925092565b6000806000606084860312156200032c576200032b620000b2565b5b600084015167ffffffffffffffff8111156200034d576200034c620000b7565b5b6200035b8682870162000208565b935050602084015167ffffffffffffffff8111156200037f576200037e620000b7565b5b6200038d8682870162000208565b9250506040620003a0868287016200025f565b9150509250925092565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680620003fc57607f821691505b602082108103620004125762000411620003b4565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026200047c7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200043d565b6200048886836200043d565b95508019841693508086168417925050509392505050565b6000819050919050565b6000620004cb620004c5620004bf846200023b565b620004a0565b6200023b565b9050919050565b6000819050919050565b620004e783620004aa565b620004ff620004f682620004d2565b8484546200044a565b825550505050565b600090565b6200051662000507565b62000523818484620004dc565b505050565b5b818110156200054b576200053f6000826200050c565b60018101905062000529565b5050565b601f8211156200059a576200056481620004418565b6200056f8462000428565b810160208510156200057f578190505b620005976200058e8562000428565b83018262000528565b50505b505050565b600082821c905092915050565b6000620005bf600019846008026200059f565b1980831691505092915050565b6000620005da8383620005ac565b9150826002028217905092915050565b620005f582620003aa565b67ffffffffffffffff811115620006115762000610620000d7565b5b6200061d8254620003e3565b6200062a8282856200054f565b600060209050601f8311600181146200066257600084156200064d578287015190505b620006598582620005cc565b865550620006c9565b601f1984166200067286620004418565b60005b828110156200069c5784890151825560018201915060208501945060208101905062000675565b86831015620006bc5784890151620006b8601f891682620005ac565b8355505b6001600288020188555050505b505050505050565b610b0a80620006dc6000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c80633950935111610071578063395093511461016857806370a082311461019857806395d89b41146101c8578063a457c2d7146101e6578063a9059cbb14610216578063dd62ed3e14610246576100a9565b806306fdde03146100ae578063095ea7b3146100cc57806318160ddd146100fc57806323b872dd1461011a578063313ce5671461014a575b600080fd5b6100b6610276565b6040516100c39190610804565b60405180910390f35b6100e660048036038101906100e191906108bf565b610308565b6040516100f3919061091a565b60405180910390f35b61010461032b565b6040516101119190610944565b60405180910390f35b610134600480360381019061012f919061095f565b610335565b604051610141919061091a565b60405180910390f35b610152610364565b60405161015f91906109ce565b60405180910390f35b610182600480360381019061017d91906108bf565b61036d565b60405161018f919061091a565b60405180910390f35b6101b260048036038101906101ad91906109e9565b6103a4565b6040516101bf9190610944565b60405180910390f35b6101d06103ec565b6040516101dd9190610804565b60405180910390f35b61020060048036038101906101fb91906108bf565b61047e565b60405161020d919061091a565b60405180910390f35b610230600480360381019061022b91906108bf565b6104f5565b60405161023d919061091a565b60405180910390f35b610260600480360381019061025b9190610a16565b610518565b60405161026d9190610944565b60405180910390f35b60606003805461028590610a85565b80601f01602080910402602001604051908101604052809291908181526020018280546102b190610a85565b80156102fe5780601f106102d3576101008083540402835291602001916102fe565b820191906000526020600020905b8154815290600101906020018083116102e157829003601f168201915b5050505050905090565b60008061031361059f565b90506103208185856105a7565b600191505092915050565b6000600554905090565b60008061034061059f565b905061034d858285610770565b6103588585856107fc565b60019150509392505050565b60006012905090565b60008061037861059f565b905061039981858561038a8589610518565b6103949190610ae5565b6105a7565b600191505092915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6060600480546103fb90610a85565b80601f016020809104026020016040519081016040528092919081815260200182805461042790610a85565b80156104745780601f1061044957610100808354040283529160200191610474565b820191906000526020600020905b81548152906001019060200180831161045757829003601f168201915b5050505050905090565b60008061048961059f565b905060006104978286610518565b9050838110156104dc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104d390610b8b565b60405180910390fd5b6104e982868684036105a7565b60019250505092915050565b60008061050061059f565b905061050d8185856107fc565b600191505092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610616576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161060d90610c1d565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610685576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161067c90610caf565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925836040516107639190610944565b60405180910390a3505050565b600061077c8484610518565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146107f657818110156107e8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107df90610d1b565b60405180910390fd5b6107f584848484036105a7565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361086b576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161086290610dad565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036108da576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108d190610e3f565b60405180910390fd5b6108e5838383610a72565b505050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561092457808201518184015260208101905061090957565b60008484015250505050565b6000601f19601f8301169050919050565b600061094c826108ea565b61095681856108f5565b9350610966818560208601610906565b61096f81610930565b840191505092915050565b6000602082019050818103600083015261099481846108f5565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006109cc826109a1565b9050919050565b6109dc816109c1565b81146109e757600080fd5b50565b6000813590506109f9816109d3565b92915050565b6000819050919050565b610a12816109ff565b8114610a1d57600080fd5b50565b600081359050610a2f81610a09565b92915050565b60008060408385031215610a4c57610a4b61099c565b5b6000610a5a858286016109ea565b9250506020610a6b85828601610a20565b9150509250929050565b505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610ac157607f821691505b602082108103610ad457610ad3610a7a565b5b50919050565b610ae3816109ff565b82525050565b6000602082019050610afe6000830184610ada565b92915050565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b6000610b606025836108f5565b9150610b6b82610b04565b604082019050919050565b60006020820190508181036000830152610b8f81610b53565b9050919050565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b6000610bf26024836108f5565b9150610bfd82610b96565b604082019050919050565b60006020820190508181036000830152610c2181610be5565b9050919050565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b6000610c846022836108f5565b9150610c8f82610c28565b604082019050919050565b60006020820190508181036000830152610cb381610c77565b9050919050565b7f45524332303a20696e73756666696369656e7420616c6c6f77616e6365000000600082015250565b6000610cf0601d836108f5565b9150610cfb82610cba565b602082019050919050565b60006020820190508181036000830152610d1f81610ce3565b9050919050565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b6000610d826025836108f5565b9150610d8d82610d26565b604082019050919050565b60006020820190508181036000830152610db181610d75565b9050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b6000610e146023836108f5565b9150610e1f82610db8565b604082019050919050565b60006020820190508181036000830152610e4381610e07565b905091905056fea264697066735822122089f8e3c8f7e8c8f7e8c8f7e8c8f7e8c8f7e8c8f7e8c8f7e8c8f7e8c8f7e8c864736f6c63430008130033';

async function deployTestToken(
    wallet: ethers.Wallet,
    name: string,
    symbol: string,
    initialSupply: string
): Promise<string> {
    console.log(`\nDeploying ${name} (${symbol})...`);

    const factory = new ethers.ContractFactory(ERC20_ABI, ERC20_BYTECODE, wallet);

    const supply = ethers.parseEther(initialSupply);
    const contract = await factory.deploy(name, symbol, supply);

    console.log('Transaction sent:', contract.deploymentTransaction()?.hash);
    await contract.waitForDeployment();

    const address = await contract.getAddress();
    console.log(`✅ ${name} deployed at:`, address);

    return address;
}

async function main() {
    // Load wallet from agent data
    const agentsData = JSON.parse(
        fs.readFileSync(path.join(process.cwd(), '.data', 'agents.json'), 'utf-8')
    );

    const apiKey = 'uniskill_3c6564e39f0649ee9826225403c97cd8';
    const agent = agentsData[apiKey];

    if (!agent) {
        throw new Error('Agent not found');
    }

    // Decrypt wallet
    const { getWalletFromEncrypted } = await import('../lib/ethereum');
    const wallet = await getWalletFromEncrypted(
        process.env.WALLET_ENCRYPTION_PASSWORD!,
        agent.encryptedPrivateKey,
        agent.encryptionIv
    );

    console.log('=== Deploying Test Token ===');
    console.log('Wallet:', wallet.address);
    console.log('Balance:', ethers.formatEther(await wallet.provider.getBalance(wallet.address)), 'ETH');

    // Deploy test token
    const tokenAddress = await deployTestToken(
        wallet,
        'Test USD Coin',
        'TUSDC',
        '1000000' // 1M tokens
    );

    // Save token info
    const tokenInfo = {
        name: 'Test USD Coin',
        symbol: 'TUSDC',
        address: tokenAddress,
        decimals: 18,
        initialSupply: '1000000',
        deployedAt: new Date().toISOString(),
        deployer: wallet.address,
    };

    fs.writeFileSync(
        path.join(process.cwd(), 'test-token.json'),
        JSON.stringify(tokenInfo, null, 2)
    );

    console.log('\n✅ Token deployment complete!');
    console.log('Token info saved to test-token.json');
    console.log('\nNext steps:');
    console.log('1. Initialize pool with this token + WETH');
    console.log('2. Add liquidity');
    console.log('3. Test swap');
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error('Error:', error);
        process.exit(1);
    });
